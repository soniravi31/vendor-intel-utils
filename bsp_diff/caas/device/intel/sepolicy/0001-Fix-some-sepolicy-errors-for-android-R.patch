From 78bc1203ebd05056224b266ac44ba1812cdfc97d Mon Sep 17 00:00:00 2001
From: "ji, zhenlong z" <zhenlong.z.ji@intel.com>
Date: Tue, 2 Jun 2020 12:02:27 +0800
Subject: [PATCH] Fix some sepolicy errors for android R

Change-Id: I2b8baaa52f4cf5783757ca5b3f0da45bf0319193
Tracked-On: OAM-91243
Signed-off-by: ji, zhenlong z <zhenlong.z.ji@intel.com>
Reviewed-on: https://android.intel.com:443/689870
---
 aafd/aafd.te                                | 2 --
 crashlogd/dumpstate_dropbox.te              | 2 --
 ethernet/common/property_contexts           | 1 +
 ethernet/common/vendor_init.te              | 1 -
 graphics/mesa/hal_neuralnetworks_default.te | 1 -
 graphics/mesa/hal_power_service.te          | 1 +
 kernel/domain.te                            | 2 --
 power/hal_power_service.te                  | 5 +----
 8 files changed, 3 insertions(+), 12 deletions(-)
 create mode 100644 ethernet/common/property_contexts
 delete mode 100644 ethernet/common/vendor_init.te
 delete mode 100644 graphics/mesa/hal_neuralnetworks_default.te

diff --git a/aafd/aafd.te b/aafd/aafd.te
index 5ed9389..dc52d70 100644
--- a/aafd/aafd.te
+++ b/aafd/aafd.te
@@ -16,8 +16,6 @@ allow aafd sysfs_devices_system_cpu:file w_file_perms;
 allow aafd sysfs_dm:dir r_dir_perms;
 allow aafd sysfs_dm:file w_file_perms;
 allow aafd sysfs_dt_firmware_android:dir r_dir_perms;
-allow aafd sysfs_health2_0_management:dir r_dir_perms;
-allow aafd sysfs_health2_0_management:file w_file_perms;
 allow aafd sysfs_hwrandom:dir r_dir_perms;
 allow aafd sysfs_hwrandom:file w_file_perms;
 allow aafd sysfs_loop:dir r_dir_perms;
diff --git a/crashlogd/dumpstate_dropbox.te b/crashlogd/dumpstate_dropbox.te
index b0fdb80..e6f9d5b 100644
--- a/crashlogd/dumpstate_dropbox.te
+++ b/crashlogd/dumpstate_dropbox.te
@@ -13,8 +13,6 @@ userdebug_or_eng(`
   # breaks treble, but its a permisisve debug domain so just dontaudit it.
   dontaudit dumpstate_dropbox dropbox_service:service_manager find;
 
-  set_prop(dumpstate_dropbox, ctl_dumpstate_prop)
-
   # Breaks treble, just ignore it.
   dontaudit dumpstate_dropbox dumpstate_socket:sock_file write;
   dontaudit dumpstate_dropbox dumpstate:unix_stream_socket connectto;
diff --git a/ethernet/common/property_contexts b/ethernet/common/property_contexts
new file mode 100644
index 0000000..e517128
--- /dev/null
+++ b/ethernet/common/property_contexts
@@ -0,0 +1 @@
+persist.adb.tcp.port    u:object_r:exported2_system_prop:s0
diff --git a/ethernet/common/vendor_init.te b/ethernet/common/vendor_init.te
deleted file mode 100644
index abc7e81..0000000
--- a/ethernet/common/vendor_init.te
+++ /dev/null
@@ -1 +0,0 @@
-allow vendor_init shell_prop:property_service set;
diff --git a/graphics/mesa/hal_neuralnetworks_default.te b/graphics/mesa/hal_neuralnetworks_default.te
deleted file mode 100644
index ce82451..0000000
--- a/graphics/mesa/hal_neuralnetworks_default.te
+++ /dev/null
@@ -1 +0,0 @@
-allow hal_neuralnetworks_default graphics_device:dir search;
diff --git a/graphics/mesa/hal_power_service.te b/graphics/mesa/hal_power_service.te
index e117e0d..c5f45fc 100644
--- a/graphics/mesa/hal_power_service.te
+++ b/graphics/mesa/hal_power_service.te
@@ -1 +1,2 @@
+allowxperm hal_power_service fs_type:file ioctl { FIOCLEX FIONCLEX };
 allow hal_power_service sysfs_app_readable:file rw_file_perms;
diff --git a/kernel/domain.te b/kernel/domain.te
index 4d1a52d..6e95778 100644
--- a/kernel/domain.te
+++ b/kernel/domain.te
@@ -3,10 +3,8 @@ dontaudit {
 	dumpstate
 	init
 	installd
-	install_recovery
 	lmkd
 	netd
-	perfprofd
 	recovery
 	sdcardd
 	tee
diff --git a/power/hal_power_service.te b/power/hal_power_service.te
index b2e8f7a..b16801d 100644
--- a/power/hal_power_service.te
+++ b/power/hal_power_service.te
@@ -1,9 +1,6 @@
-type hal_power_service, domain;
-hal_server_domain(hal_power_service, hal_power)
-
 type hal_power_service_exec, exec_type, vendor_file_type, file_type;
-init_daemon_domain(hal_power_service)
 
 allow hal_power_service cgroup:file rw_file_perms;
+allowxperm hal_power_service fs_type:file ioctl { FIOCLEX FIONCLEX };
 allow hal_power_service sysfs_devices_system_cpu:file rw_file_perms;
 allow hal_power_service sysfs_power:file r_file_perms;
-- 
2.17.1

